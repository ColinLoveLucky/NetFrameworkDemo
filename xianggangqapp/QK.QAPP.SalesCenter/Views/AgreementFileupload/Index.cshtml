
    @{
        Layout = null;
    }

    <!DOCTYPE HTML>
    <html>
    <head>
        <meta name="viewport" content="width=device-width" />
        <title>File Upload</title>
        <link href="/Content/assets/css/jquery.gritter.css" rel="stylesheet">

        <link href="/Content/assets/css/bootstrap.min.css" rel="stylesheet">
        <link href="/Content/assets/css/font-awesome.min.css" rel="stylesheet">
        <link href="/Content/assets/css/Customer.css" rel="stylesheet">


        <script src="../Content/assets/js/jquery-2.0.3.min.js"></script>

        <script src="/Content/assets/js/bootbox.min.js"></script>
        <script src="/Content/assets/js/jquery.validate.min.js"></script>
        <script src="/Content/assets/js/jquery.validate.unobtrusive.min.js"></script>
        <script src="/Content/assets/js/additional-methods.min.js"></script>
        <script src="/Content/assets/js/jquery.maskedinput.min.js"></script>
        <script src="/Content/assets/js/date-time/bootstrap-datepicker.min.js"></script>
        <script src="/Content/assets/js/select2.min.js"></script>
        <script src="/Content/assets/js/jquery-ui-1.10.3.full.min.js"></script>
        <script src="/Content/assets/js/date-time/datepicker-zh-TW.js"></script>
        <script src="/Content/assets/js/library/golbal.js"></script>
        <script src="/Content/assets/js/fuelux/qb.agreement.Customer.js"></script>

        @Styles.Render("~/Content/assets/css/fileupload")
    </head>
    <body>
        <div class="main-container">
            <div class="sidebar sidebar-fixed">
                @System.Web.Mvc.MvcHtmlString.Create(ViewBag.htmlString)
                @*<div id='container' style="height: auto; margin: 0 0;">
                 
                    <div class="dropdown">
                        <a id="drpupload" data-toggle="dropdown" class="btn dropdown-toggle" style="text-align:left">
                            选择上传
                            <span class="caret"></span>
                        </a>
                        <ul id="drpupul" role="menu" aria-labelledby="dLabel">
                            <li><a id="dropup0" name="dropup0">借款咨询与服务协议-房屋抵押</a></li>
                            <li><a id="dropup1" name="dropup1">借款咨询与服务协议-房屋抵押</a></li>
                        </ul>
                    </div>
                    <div class="panel-group" id="accordion">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h4 class="panel-title">
                                    <a data-toggle="collapse" data-parent="#accordion"
                                       href="#collapseOne">
                                        选择上传
                                    </a>
                                </h4>
                            </div>
                            <div id="collapseOne" class="panel-collapse collapse">
                                <div class="panel-body">

                                    <a id="dropup0" name="dropup0" style="text-align:left">借款咨询与服务协议-房屋抵押</a><br />
                                    <a id="dropup1" name="dropup1" style="text-align:left">借款咨询与服务协议-房屋抵押</a>


                                </div>
                            </div>
                        </div>

                    </div>
                        <div class='cnfg'>
                            <i id='SortImg' class='icon-edit' title='编辑(自动保存变更)'></i>
                            <i id='CloseSortImg' class='icon-check' title='关闭编辑'></i>
                        </div>
                    </div>*@
               
                
                <div id="filelist" class="plupload_filelist" style="height:200px">
                    @for (int i = 0; i < (ViewData["FILES"] as List<Dictionary<string, QK.QAPP.Entity.FILE_LIST.FILE>>).Count; i++)
                    {
                        foreach (KeyValuePair<string, QK.QAPP.Entity.FILE_LIST.FILE> kv in (ViewData["FILES"] as List<Dictionary<string, QK.QAPP.Entity.FILE_LIST.FILE>>)[i])
                        {

                            if (kv.Value.E_AUTO != null)
                            {
                                <div class="column-@kv.Value.E_AUTO.FILE_ID">
                                    <div class="DragImg">
                                        <div class="dltImg icon-remove-sign" onclick="deleteImg('@kv.Value.E_AUTO.FILE_ID&E_AUTO',this,false);" title="删除">
                                        </div>
                                    </div>
                                    <div class="SmallImg">
                                        <div class="portlet-header" id="@kv.Value.E_AUTO.FILE_ID">
                                            @if (kv.Value.E_AUTO.FILE_TYPE.ToUpper().Contains("PDF"))
                                            {
                                                <img longdesc="@kv.Value.E_AUTO.FILE_PATH" src="../Content/images/pdf.png" title="@kv.Value.E_AUTO.FILE_TITLE@MvcHtmlString.Create(".") @kv.Value.E_AUTO.FILE_TYPE" />
                                            }
                                            else if (kv.Value.E_AUTO.FILE_TYPE.ToUpper().Contains("DOC"))
                                            {
                                                <img longdesc="@kv.Value.E_AUTO.FILE_PATH" src="../Content/images/docx.png" title="@kv.Value.E_AUTO.FILE_TITLE@MvcHtmlString.Create(".") @kv.Value.E_AUTO.FILE_TYPE" />
                                            }
                                            else
                                            {
                                                <img src="@kv.Value.E_AUTO.FILE_PATH" longdesc="@kv.Value.E_AUTO.FILE_PATH" title="@kv.Value.E_AUTO.FILE_TITLE" />
                                            }
                                            @kv.Value.E_AUTO.FILE_TITLE@MvcHtmlString.Create(".") @kv.Value.E_AUTO.FILE_TYPE
                                        </div>
                                    </div>
                                </div>
                            }
                            if (kv.Value.E_MANUAL_FINAL != null)
                            {
                                <div class="column-@kv.Value.E_MANUAL_FINAL.FILE_ID">
                                    <div class="DragImg">
                                        <div class="dltImg icon-remove-sign" onclick="deleteImg('@kv.Value.E_MANUAL_FINAL.FILE_ID&E_MANUAL_FINAL',this,false);" title="删除">
                                        </div>
                                    </div>
                                    <div class="SmallImg">
                                        <div class="portlet-header" id="@kv.Value.E_MANUAL_FINAL.FILE_ID">
                                            @if (kv.Value.E_MANUAL_FINAL.FILE_TYPE.ToUpper().Contains("PDF"))
                                            {
                                                <img longdesc="@kv.Value.E_MANUAL_FINAL.FILE_PATH" src="../Content/images/pdf.png" title="@kv.Value.E_MANUAL_FINAL.FILE_TITLE@MvcHtmlString.Create(".") @kv.Value.E_MANUAL_FINAL.FILE_TYPE" />
                                            }
                                            else if (kv.Value.E_MANUAL_FINAL.FILE_TYPE.ToUpper().Contains("DOC"))
                                            {
                                                <img longdesc="@kv.Value.E_MANUAL_FINAL.FILE_PATH" src="../Content/images/docx.png" title="@kv.Value.E_MANUAL_FINAL.FILE_TITLE@MvcHtmlString.Create(".") @kv.Value.E_MANUAL_FINAL.FILE_TYPE" />
                                            }
                                            else
                                            {
                                                <img src="@kv.Value.E_MANUAL_FINAL.FILE_PATH" longdesc="@kv.Value.E_MANUAL_FINAL.FILE_PATH" title="@kv.Value.E_MANUAL_FINAL.FILE_TITLE" />
                                            }
                                            @kv.Value.E_MANUAL_FINAL.FILE_TITLE@MvcHtmlString.Create(".") @kv.Value.E_MANUAL_FINAL.FILE_TYPE
                                        </div>
                                    </div>
                                </div>
                            }
                            if (kv.Value.P_MANUAL_FINAL != null)
                            {
                                <div class="column-@kv.Value.P_MANUAL_FINAL.FILE_ID">
                                    <div class="DragImg">
                                        <div class="dltImg icon-remove-sign" onclick="deleteImg('@kv.Value.P_MANUAL_FINAL.FILE_ID&P_MANUAL_FINAL',this,false);" title="删除">
                                        </div>
                                    </div>
                                    <div class="SmallImg">
                                        <div class="portlet-header" id="@kv.Value.P_MANUAL_FINAL.FILE_ID">
                                            @if (kv.Value.P_MANUAL_FINAL.FILE_TYPE.ToUpper().Contains("PDF"))
                                            {
                                                <img longdesc="@kv.Value.P_MANUAL_FINAL.FILE_PATH" src="../Content/images/pdf.png" title="@kv.Value.P_MANUAL_FINAL.FILE_TITLE@MvcHtmlString.Create(".") @kv.Value.P_MANUAL_FINAL.FILE_TYPE" />
                                            }
                                            else if (kv.Value.P_MANUAL_FINAL.FILE_TYPE.ToUpper().Contains("DOC"))
                                            {
                                                <img longdesc="@kv.Value.P_MANUAL_FINAL.FILE_PATH" src="../Content/images/docx.png" title="@kv.Value.P_MANUAL_FINAL.FILE_TITLE@MvcHtmlString.Create(".") @kv.Value.P_MANUAL_FINAL.FILE_TYPE" />
                                            }
                                            else
                                            {
                                                <img src="@kv.Value.P_MANUAL_FINAL.FILE_PATH" longdesc="@kv.Value.P_MANUAL_FINAL.FILE_PATH" title="@kv.Value.P_MANUAL_FINAL.FILE_TITLE" />
                                            }
                                            @kv.Value.P_MANUAL_FINAL.FILE_TITLE@MvcHtmlString.Create(".") @kv.Value.P_MANUAL_FINAL.FILE_TYPE
                                        </div>
                                    </div>
                                </div>
                            }

                        }


                    }


                </div>

            </div>
            <div class="main-content">
                <div class="breadcrumbs breadcrumbs-fixed">
                    <i class="icon-undo" onclick="rotateLeft('imageView', 90);" title="左旋"></i>
                    <i class="icon-repeat" onclick="rotateRight('imageView', 90);" title="右旋"></i>
                    <i class="icon-zoom-in" onclick="zoomImg(0.1);" title="放大"></i>
                    <i class="icon-zoom-out" onclick="zoomImg(-0.1);" title="缩小"></i>
                    <a class="icon-download-alt" href="javascript:void(0);" title="下载"></a>
                    <div id="divShowloading"></div>
                </div>
                <div class="page-content" id="pageContent">
                </div>
            </div>
            <div id="comfirmDialog" style="display:none;"></div>
        </div>

        @Scripts.Render("~/bundles/fileupload")
        <script src="/Content/assets/js/bootstrap.min.js"></script>
        <script type="text/javascript">
    /*本页全局变量集合*/
    var currentAPP = {};
    if (navigator.userAgent.indexOf("MSIE") > 0) {
        currentAPP.isIE = true;
    }
    if (navigator.userAgent.indexOf("Firefox") > 0) {
        currentAPP.isFirefox = true;
    }
    else if (navigator.userAgent.indexOf("Chrome") > 0) {
        currentAPP.isChrome = true;
    }
    else if (navigator.userAgent.indexOf("Safari") > 0) {
        currentAPP.isSafari = true;
    }
    else if (navigator.userAgent.indexOf("Camino") > 0) {
        currentAPP.isCamino = true;
    }
    else if (navigator.userAgent.indexOf("Gecko/") > 0) {
        currentAPP.isGecko = true;
    }
    currentAPP.html5 = (typeof (Worker) == "undefined" ? false : true);
    currentAPP.downloadUrl = "/AgreementFileupload/Download";
    currentAPP.uploadUrl = "/AgreementFileupload/UploadFile";
    currentAPP.saveOrderUrl = "/AgreementFileupload/SaveNewSort";
    currentAPP.deleteFileUrl = "/AgreementFileupload/DeleteFile";
    currentAPP.bigPicUrl = '@(ViewData["BigPicUrl"])';
    function drpuploadShow() {
        if (typeof ($("#drpupload").attr("data-toggle")) != "undefined") {
            jQuery('#drpupload').removeAttr('data-toggle');
            jQuery('#drpupload').dropdown("toggle");
        }
        else {
            jQuery('#drpupload').attr('data-toggle', 'dropdown');
        }
    }

    /*************图片上传Begin*************/
    var idx = 1;

    if ('@ViewData["IsAdditional"]' == "true") {
        getuploader("pickfiles","");
    }
    function getuploader(btnid, fileid) {
        if (fileid != "") { fileid = fileid.split('&')[0];}//如果文件id不为空，是上传操作，此时，文件id【fileid&upload】需要截取文件id部分(避免下拉文件id和展示的文件id冲突)
        var uploader = new plupload.Uploader({
            runtimes: ((currentAPP.isIE || !currentAPP.html5) ? 'flash,silverlight,html5,html4' : 'html5,flash,silverlight,html4'),
            browse_button: btnid,

            container: document.getElementById('container'),
            url: currentAPP.uploadUrl,
            max_file_size: '@(ViewData["UploadMaxSize"])kb',
            chunk_size: '@(ViewData["UploadChunkSize"])kb',
            filters: { mime_types: [{ title: "Image files", extensions: '@ViewData["UploadFileFormat"]' }] },
            flash_swf_url: '/Content/plupload/js/Moxie.swf',
            silverlight_xap_url: '/Content/plupload/js/Moxie.xap',
            init: {
                /* PostInit: function () { jQuery('#filelist').html(''); }, */
                /*选择文件后触发*/
                FilesAdded: function (up, files) {
                    var fhtml = jQuery('#filelist').html();
                    plupload.each(files, function (file) {
                        fhtml += '<div class="column-' + idx++ + '">'
                                    + '<div class="DragImg">拖动这里排序'
                                        + '<div class="dltImg icon-remove-sign" onclick="deleteImg(\'' + file.id + '\',this,-1);" title="删除"></div>'
                                    + '</div>'
                                    + '<div class="SmallImg">'
                                        + '<div class="portlet-header" id="' + file.id + '">正在上传，请稍候...<br />文件：' + file.name + '<br />大小：' + plupload.formatSize(file.size) + '</div>'
                                    + '</div>'
                                + '</div>';
                        jQuery('#filelist').html(fhtml);
                    });
                    /*选择文件后自动上传*/
                    uploader.start();
                },
                /*开始上传时触发*/
                BeforeUpload: function (up, file) {
                    /*分块上传时在.NET服务器端使用HttpPostedFileBase读取文件名有误，故将文件名作为参数传递*/
                    up.settings.multipart_params = {
                        fileId: fileid,
                        fileName: file.name,
                        bidContractNo: '@(ViewData["bidContractNo"])',
                        bidAppCode: '@(ViewData["bidAppCode"])',
                        fileType: '@(ViewData["fileType"])',
                        isAdditional: '@(ViewData["IsAdditional"])'
                    };
                },
                Error: function (up, err) {
                    var fhtml = jQuery('#filelist').html();
                    fhtml += '<div class="column-' + idx++ + '">'
                            + '<div class="dltImg icon-remove-sign" onclick="deleteImg(\'' + idx + '\',this,1);" title="删除"></div>'
                            + '<div><b>上传时发生错误</b><br />文件：' + err.file.name + "<br />信息：" + err.message + '</div>'
                            + '</div>';
                    jQuery('#filelist').html(fhtml);
                },
                /*上传完成*/
                FileUploaded: function (up, file, res) {
                    try {
                        /*res.response：服务器返回内容*/
                        data = JSON.parse(res.response);
                        if (data) {
                            jQuery('#' + file.id).html('');
                            if (data.Status == '1') {
                                jQuery.ajax({
                                    type: "post",
                                    url: '/AgreementFileupload/FileList',
                                    data: { bidContractNo: '@(ViewData["bidContractNo"])', bidAppCode: '@(ViewData["bidAppCode"])', FileType: 'protocolFile' },
                                    beforeSend: function () {

                                    },
                                    success: function (data) {
                                        if (data.Status) {
                                            if (data.ReturnObj.FILE_LIST.FILES.length == 0) {

                                            } else {
                                                jQuery('#filelist').html('');
                                                var filelistHtml = "";
                                                var imgPath = "";
                                                var data = data.ReturnObj.FILE_LIST.FILES;
                                                $.each(data, function (n, files) {
                                                    $.each(files, function (n, value) {
                                                        if (value.E_AUTO) {
                                                            if (value.E_AUTO.FILE_TYPE.toUpperCase().indexOf("PDF") == 0) {
                                                                imgPath = "../Content/images/pdf.png";
                                                            }
                                                            else if (value.E_AUTO.FILE_TYPE.toUpperCase().indexOf("DOC") == 0) {
                                                                imgPath = "../Content/images/docx.png";
                                                            }
                                                            else {

                                                                imgPath = value.E_AUTO.FILE_PATH;
                                                            }
                                                            /*成功上传后创建一个缩略图对象显示在左侧*/
                                                            filelistHtml += "  <div class=\"column-" + value.E_AUTO.FILE_ID + "\">";
                                                            filelistHtml += "    <div class=\"DragImg\">";
                                                            filelistHtml += "       <div class=\"dltImg icon-remove-sign\" onclick=\"deleteImg('" + value.E_AUTO.FILE_ID + "&E_AUTO',this,false);\" title=\"删除\">";
                                                            filelistHtml += "         </div>";
                                                            filelistHtml += " </div>";
                                                            filelistHtml += "<div class=\"SmallImg\">";
                                                            filelistHtml += "   <div class=\"portlet-header\" id=\"" + value.E_AUTO.FILE_ID + "\">";
                                                            filelistHtml += "         <img longdesc=\"" + value.E_AUTO.FILE_PATH + "\" src=\"" + imgPath + "\" title=\"" + value.E_AUTO.FILE_TITLE + "." + value.E_AUTO.FILE_TYPE + "\" />" + value.E_AUTO.FILE_TITLE + "</div>";
                                                            filelistHtml += "</div>";
                                                            filelistHtml += "</div>";
                                                        }
                                                        if (value.E_MANUAL_FINAL) {
                                                            if (value.E_MANUAL_FINAL.FILE_TYPE.toUpperCase().indexOf("PDF") == 0) {
                                                                imgPath = "../Content/images/pdf.png";
                                                            }
                                                            else if (value.E_MANUAL_FINAL.FILE_TYPE.toUpperCase().indexOf("DOC") == 0) {
                                                                imgPath = "../Content/images/docx.png";
                                                            }
                                                            else {

                                                                imgPath = value.E_MANUAL_FINAL.FILE_PATH;
                                                            }
                                                            /*成功上传后创建一个缩略图对象显示在左侧*/
                                                            filelistHtml += "  <div class=\"column-" + value.E_MANUAL_FINAL.FILE_ID + "\">";
                                                            filelistHtml += "    <div class=\"DragImg\">";
                                                            filelistHtml += "       <div class=\"dltImg icon-remove-sign\" onclick=\"deleteImg('" + value.E_MANUAL_FINAL.FILE_ID + "&E_MANUAL_FINAL',this,false);\" title=\"删除\">";
                                                            filelistHtml += "         </div>";
                                                            filelistHtml += " </div>";
                                                            filelistHtml += "<div class=\"SmallImg\">";
                                                            filelistHtml += "   <div class=\"portlet-header\" id=\"" + value.E_MANUAL_FINAL.FILE_ID + "\">";
                                                            filelistHtml += "         <img longdesc=\"" + value.E_MANUAL_FINAL.FILE_PATH + "\" src=\"" + imgPath + "\" title=\"" + value.E_MANUAL_FINAL.FILE_TITLE + "." + value.E_MANUAL_FINAL.FILE_TYPE + "\" />" + value.E_MANUAL_FINAL.FILE_TITLE + "</div>";
                                                            filelistHtml += "</div>";
                                                            filelistHtml += "</div>";
                                                        }
                                                        if (value.P_MANUAL_FINAL) {
                                                            if (value.P_MANUAL_FINAL.FILE_TYPE.toUpperCase().indexOf("PDF") == 0) {
                                                                imgPath = "../Content/images/pdf.png";
                                                            }
                                                            else if (value.P_MANUAL_FINAL.FILE_TYPE.toUpperCase().indexOf("DOC") == 0) {
                                                                imgPath = "../Content/images/docx.png";
                                                            }
                                                            else {

                                                                imgPath = value.P_MANUAL_FINAL.FILE_PATH;
                                                            }
                                                            /*成功上传后创建一个缩略图对象显示在左侧*/
                                                            filelistHtml += "  <div class=\"column-" + value.P_MANUAL_FINAL.FILE_ID + "\">";
                                                            filelistHtml += "    <div class=\"DragImg\">";
                                                            filelistHtml += "       <div class=\"dltImg icon-remove-sign\" onclick=\"deleteImg('" + value.P_MANUAL_FINAL.FILE_ID + "&P_MANUAL_FINAL',this,false);\" title=\"删除\">";
                                                            filelistHtml += "         </div>";
                                                            filelistHtml += " </div>";
                                                            filelistHtml += "<div class=\"SmallImg\">";
                                                            filelistHtml += "   <div class=\"portlet-header\" id=\"" + value.P_MANUAL_FINAL.FILE_ID + "\" >";
                                                            filelistHtml += "         <img longdesc=\"" + value.P_MANUAL_FINAL.FILE_PATH + "\" src=\"" + imgPath + "\" title=\"" + value.P_MANUAL_FINAL.FILE_TITLE + "." + value.P_MANUAL_FINAL.FILE_TYPE + "\" />" + value.P_MANUAL_FINAL.FILE_TITLE + "</div>";
                                                            filelistHtml += "</div>";
                                                            filelistHtml += "</div>";
                                                        }
                                                    });

                                                });
                                                jQuery('#filelist').append(filelistHtml);
                                                clickSmallPic();
                                            }
                                        }
                                    },
                                    error: function () {
                                        /*成功上传后创建一个缩略图对象显示在左侧*/
                                        jQuery('#' + file.id).parent().parent().find('.dltImg').attr('onclick', 'deleteImg(\'' + data.ReturnObj.FileId + '\',this,0);');
                                        jQuery('#' + file.id).attr('id', data.ReturnObj.FileId);
                                        jQuery('<img />').attr('src', currentAPP.bigPicUrl + "?id=" + data.ReturnObj.FileId).attr('title', data.ReturnObj.OldFileName).appendTo(jQuery('#' + data.ReturnObj.FileId));
                                        jQuery('#' + data.ReturnObj.FileId).append('<br />' + data.ReturnObj.OldFileName);

                                    }
                                });
                            } else {
                                jQuery('#' + file.id).html('<div><b>上传时发生错误</b><br />文件：' + data.RESULT + "<br />错误：" + data.CODE + '</div>');
                            }
                        }
                    }
                    catch (e) {
                        if (res.response.indexOf('<!DOCTYPE') > -1) {
                            jQuery('#' + file.id).html('<div><b>上传时发生错误</b><br />文件：' + file.name + '<br />错误：登录已失效，须重新登录后再上传。</div>');
                        } else {
                            jQuery('#' + file.id).html('<div><b>上传时发生错误</b><br />文件：' + file.name + '<br />错误：' + res.response + '</div>');
                        }
                    }
                },
                UploadComplete: function (up, file) {
                    /*为缩略图绑定事件*/
                    clickSmallPic();
                }
            }
        });
        uploader.init();
    }


    /*为缩略图绑定事件*/
    function clickSmallPic() {
        jQuery('.portlet-header').click(function () {
            jQuery('#pageContent').html('');
            var imgId = jQuery(this).attr('id');
            var imgUrl = "?theName=" + escape(jQuery(this).children('img').attr('title')) + "&theSrc=" + escape(jQuery(this).children('img').attr('longdesc') );
            imgUrl += "&theId=" + imgId + "&bidCode=" + '@(ViewData["bidCode"])';
            var srcUrl = jQuery(this).children('img').attr('src');
            jQuery('<img />').attr('id', 'imageView')
                .attr('src', srcUrl)
                .attr('rel', srcUrl)
                .appendTo(jQuery('#pageContent'));

            currentAPP.rotate = false;
            currentAPP.imgRatio = undefined;
            /*为下载按钮指定下载地址*/
            jQuery('.icon-download-alt').attr('href', currentAPP.downloadUrl + imgUrl).attr('target', '_blank');
            /*可拖动*/
            jQuery('#pageContent').imageView({ width: jQuery('#pageContent').width(), height: jQuery('#pageContent').height() });
            jQuery('.clickedImg').removeClass("clickedImg");
            jQuery(this).parent().parent().addClass('clickedImg');
        });
    }
    /*************图片上传End*************/
    //初始化函数
    var uploadernum = new Array();

    jQuery(function () {

        //循环初始化upload控件
        $("#collapseOne").find("a").each(function (index) {
            getuploader($(this).attr("id"), $(this).attr("id"));
        });
        //显示隐藏文件列表
        $('#collapseOne').on('shown.bs.collapse', function () {
            $("#filelist").css("height", $(".main-container").height() - $(".panel-body").height()-15)
        })
        $('#collapseOne').on('hidden.bs.collapse', function () {
            $("#filelist").css("height", $(".main-container").height()+20)
        })

        jQuery("#filelist").each(function (index, value) {
            jQuery('.column-' + (index + 1)).each(function (idx, vae) {
                value.appendChild(vae);
            });
        });

        /*拖动排序*/
        jQuery("#filelist").sortable({
            connectWith: "#filelist",
            revert: true,
            cursor: "move",
            opacity: 0.6,
            scrollSensitivity: 100,
            scrollSpeed: 100,
            tolerance: 'pointer',
            forcePlaceholderSize: true,
            delay: 200,
            handle: '.DragImg',
            /*一次拖动排序完成后自动触发*/
            update: function (event, ui) {
                /*******排序接口，排序**************/
                var idList = [];
                jQuery('.portlet-header').each(function () {
                    idList.push(jQuery(this).attr('id'));
                })
                var ids = idList.join(',');
                jQuery.ajax({
                    type: "post",
                    url: currentAPP.saveOrderUrl,
                    data: { newOrder: ids },
                    beforeSend: function () {
                        jQuery('#divShowloading').html("<img src='/Content/assets/images/loading.gif'/> 正在更新...");
                    },
                    success: function (msg) {
                        if (msg.Status == '1') {
                            jQuery('#divShowloading').html("更新成功！");
                        }
                        else {
                            jQuery('#divShowloading').html("更新失败！");
                        }
                    }
                });

            }
        });
        jQuery('#CloseSortImg').hide();

        jQuery('#SortImg').click(function () {
            jQuery('#SortImg').hide();
            jQuery('#CloseSortImg').show();
            jQuery('#pickfiles').hide();
            jQuery('#container').find('input').hide();
            jQuery('#container').find('object').hide();
            jQuery('.DragImg').show(300);
        });
        jQuery('#CloseSortImg').click(function () {
            jQuery('#CloseSortImg').hide();
            jQuery('#SortImg').show();
            jQuery('#pickfiles').show();
            jQuery('#container').find('input').show();
            jQuery('#container').find('object').show();
            jQuery('.DragImg').hide(300);
        });
    });

    /*删除某缩略图*/
    function deleteImg(id, el, isClient) {
        if (isClient == 1) {
            jQuery(el).parent().remove();
            return;
        }
        if (isClient == -1) {
            jQuery(el).parent().parent().remove();
            return;
        }
        var fileProperty = id.split('&');//分割文件id和类型
        var targetImg = jQuery('#' + fileProperty[0]).children("img");
        if (confirm('确定要删除文件【' + targetImg.attr("title") + '】吗？')) {

            jQuery.ajax({
                type: "post",
                url: currentAPP.deleteFileUrl, /*服务端处理程序*/
                data: {
                    fileId: fileProperty[0],
                    bidContractNo: '@(ViewData["bidContractNo"])',
                    bidAppCode: '@(ViewData["bidAppCode"])',
                    fileType: fileProperty[1]
                },
                beforeSend: function () {
                    jQuery('#divShowloading').html("<img src='/Content/assets/images/loading.gif' class='loadingImg' /> 正在删除【" + targetImg.attr('title') + "】...");
                    jQuery(el).attr("disabled", "disabled");
                },
                complete: function () {
                    jQuery(el).removeAttr("disabled");
                },
                success: function (msg) {
                    if (msg.Status == "1") {
                        jQuery('#divShowloading').html("删除【" + targetImg.attr('title') + "】成功！");
                        if (targetImg.attr('src') == jQuery('#pageContent').children('img').attr('src')) {
                            jQuery('#pageContent').html('');
                            jQuery('.icon-download-alt').attr('href', 'javascript:void(0);').removeAttr('target');
                        }
                        jQuery(el).parent().parent().remove();
                    }
                    else {
                        jQuery('#divShowloading').html("删除【" + targetImg.attr('title') + "】失败！");
                    }
                }, error: function () {
                    jQuery('#divShowloading').html("删除【" + targetImg.attr('title') + "】时出错！");
                }
            });
        }
    };
    /*************左侧缩略图拖动和删除End*************/

    /*************图片旋转Begin*************/
    function rotate(id, angle, whence) {
        var p = document.getElementById(id);
        if (!p) { return; }
        if (!whence) {
            p.angle = ((p.angle == undefined ? 0 : p.angle) + angle) % 360;
        }
        else {
            p.angle = angle;
        }
        if (p.angle >= 0) {
            var rotation = Math.PI * p.angle / 180;
        }
        else {
            var rotation = Math.PI * (360 + p.angle) / 180;
        }
        var costheta = Math.cos(rotation);
        var sintheta = Math.sin(rotation);
        /*不支持HTML5、IE浏览器*/
        if (currentAPP.isIE && !currentAPP.html5) {
            var canvas = document.createElement('img');
            canvas.src = p.src;
            canvas.height = p.height;
            canvas.width = p.width;
            canvas.style.filter = "progid:DXImageTransform.Microsoft.Matrix(M11=" + costheta + ",M12=" + (-sintheta) + ",M21=" + sintheta + ",M22=" + costheta + ",SizingMethod='auto expand')";
        }
            /*支持HTML5的其他浏览器*/
        else {
            var canvas = document.createElement('canvas');
            if (!p.oImage) {
                canvas.oImage = new Image();
                canvas.oImage.src = p.src;
            }
            else {
                canvas.oImage = p.oImage;
            }
            canvas.style.width = canvas.width = Math.abs(costheta * canvas.oImage.width) + Math.abs(sintheta * canvas.oImage.height);
            canvas.style.height = canvas.height = Math.abs(costheta * canvas.oImage.height) + Math.abs(sintheta * canvas.oImage.width);
            var context = canvas.getContext('2d');
            context.save();
            if (rotation <= Math.PI / 2) {
                context.translate(sintheta * canvas.oImage.height, 0);
            }
            else if (rotation <= Math.PI) {
                context.translate(canvas.width, -costheta * canvas.oImage.height);
            }
            else if (rotation <= 1.5 * Math.PI) {
                context.translate(-costheta * canvas.oImage.width, canvas.height);
            }
            else {
                context.translate(0, -sintheta * canvas.oImage.width);
            }
            context.rotate(rotation);
            context.drawImage(canvas.oImage, 0, 0, canvas.oImage.width, canvas.oImage.height);
            context.restore();
            canvas.style.height = p.style.width;
            canvas.style.width = p.style.height;
        }
        canvas.id = p.id;
        canvas.angle = p.angle;
        p.parentNode.replaceChild(canvas, p);
        /*记录是否已经旋转*/
        currentAPP.rotate = (currentAPP.rotate == true ? false : true)
        jQuery('#pageContent').imageView({ width: jQuery('#pageContent').width(), height: jQuery('#pageContent').height() });
    }

    /*向右旋转*/
    function rotateRight(id, angle) {
        rotate(id, angle == undefined ? 90 : angle);
    }

    /*向左旋转*/
    function rotateLeft(id, angle) {
        rotate(id, angle == undefined ? -90 : -angle);
    }
    /*************图片旋转End*************/

    /*放大或缩小右下侧大图*/
    function zoomImg(o) {
        var h = parseInt(jQuery('#imageView').css('height'), 10);
        var hback = h;
        var w = parseInt(jQuery('#imageView').css('width'), 10);
        var wback = w;
        if (currentAPP.imgRatio == undefined) {
            if (currentAPP.rotate) {
                currentAPP.imgRatio = w / h;
            } else {
                currentAPP.imgRatio = h / w;
            }
        }
        w = parseInt(w * (1 + o), 10);
        if (w > 10) {
            if (currentAPP.isIE && !currentAPP.html5) {
                if (currentAPP.rotate) {
                    h = parseInt(w / currentAPP.imgRatio, 10);
                    jQuery('#imageView').css('height', w).css('width', h);
                } else {
                    h = parseInt(w * currentAPP.imgRatio, 10);
                    jQuery('#imageView').css('height', h).css('width', w);
                }
            } else {
                if (currentAPP.rotate) {
                    h = parseInt(w / currentAPP.imgRatio, 10);
                } else {
                    h = parseInt(w * currentAPP.imgRatio, 10);
                }
                jQuery('#imageView').css('height', h).css('width', w);
            }
            setPosition(h, w, hback, wback);
        }
        return false;
    }

    /*图片放大时为了将图片控制在可视范围做的处理*/
    /*h:放大后的height*/
    /*w:放大后的width*/
    /*hback:放大前的height*/
    /*wback:放大前的width*/
    var setPosition = function (h, w, hback, wback) {
        var imgWidth = jQuery('#imageView').width();
        var imgHeight = jQuery('#imageView').height();
        var parentWidth = jQuery('#pageContent').width();
        var parentHeight = jQuery('#pageContent').height();
        /*根据原位置计算出来的left*/
        var lft = parseInt(jQuery('#imageView').css('left')) + (wback - w) / 2;
        /*缩小*/
        if ((wback - w) > 0) {
            /*图片左上角不进入容器*/
            if (lft >= 0) {
                lft = 0;
            }
                /*图片往左上角移去了，把它移下来*/
            else if (parentWidth < w && (imgWidth + lft) < parentWidth) {
                lft = parseInt(jQuery('#imageView').css('left')) + (wback - w);
            }
        } else if (lft < 0 && (parentWidth > w || parentHeight > h)) {
            lft = 0;
        }
        jQuery('#imageView').css('left', lft);
        /*根据原位置计算出来的top*/
        var tp = parseInt(jQuery('#imageView').css('top')) + (hback - h) / 2;
        /*缩小*/
        if ((hback - h) > 0) {
            /*图片左上角不进入容器*/
            if (tp >= 0) {
                tp = 0;
            }
                /*图片往左上角移去了，把它移下来*/
            else if (parentHeight < h && (imgHeight + tp) < parentHeight) {
                tp = parseInt(jQuery('#imageView').css('top')) + (hback - h);
            }
        } else if (tp < 0 && (parentHeight > h || parentWidth > w)) {
            tp = 0;
        }
        jQuery('#imageView').css('top', tp);
    }

    /*滚轮触发方法*/
    var scrollFunc = function (event) {
        event = event || window.event;/*浏览器兼容*/
        var direct = 0;
        /*firefox之外*/
        if (event.wheelDelta) {
            direct = event.wheelDelta > 0 ? 0.1 : -0.1;
        }
            /*firefox*/
        else if (event.detail) {
            direct = event.detail < 0 ? 0.1 : -0.1;
        }
        zoomImg(direct);
        /*禁用浏览器的滚动条以防止滚轮时抖动*/
        if (event && event.preventDefault) {
            event.preventDefault();
            event.stopPropagation();
        } else {
            event.returnvalue = false;
            return false;
        }
    };

    function downloadImg() {
        var url = jQuery('#imageView').attr('src');
        url = currentAPP.downloadUrl + url;
        window.open(url);
    }

    /*改变浏览器窗口大小时重新计算左下右下高度*/
    function changeSideHeight() {
        jQuery('#filelist').height(jQuery(window).height() - 50);
        jQuery('#pageContent').height(jQuery(window).height() - 70);
        $("#filelist").css("height", $(".main-container").height() - $(".panel-body").height() - 15);

    }

    jQuery(function () {
        /*计算左下右下高度*/
        changeSideHeight();

        /*注册大图显示局域的鼠标滚轮事件*/
        var obj = document.getElementById('pageContent');
        if (obj.addEventListener && currentAPP.isFirefox) {
            obj.addEventListener('DOMMouseScroll', scrollFunc, false);
        } else {
            obj.onmousewheel = scrollFunc;
        }

        /*为缩略图绑定事件*/
        clickSmallPic();

        /*页面禁用选择功能*/
        jQuery('body').disableSelection();
    });

    /*改变浏览器窗口大小时重新计算左下右下高度*/
    jQuery(window).resize(function () { changeSideHeight(); });
        </script>
    </body>
</html>
